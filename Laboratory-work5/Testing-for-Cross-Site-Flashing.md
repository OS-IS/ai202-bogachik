# Тестування Cross Site Flashing

|ID|
|:---:|
|WSTG-CLNT-08|

## Конспект

ActionScript, заснований на ECMAScript, є мовою, яка використовується програмами Flash для інтерактивних потреб. Існує три версії мови ActionScript. ActionScript 1.0 і ActionScript 2.0 дуже схожі, оскільки ActionScript 2.0 є розширенням ActionScript 1.0. ActionScript 3.0, представлений у Flash Player 9, є переписаною мовою для підтримки об’єктно-орієнтованого дизайну.

ActionScript, як і будь-яка інша мова, має деякі шаблони реалізації, які можуть призвести до проблем безпеки. Зокрема, оскільки Flash-додатки часто вбудовані в браузери, такі уразливості, як DOM-based Cross Site Scripting (DOM XSS), можуть бути присутніми в несправних Flash-додатках.

Cross-Site Flashing (XSF) — це вразливість, яка має подібний вплив на XSS.

XSF виникає, коли такі сценарії ініціюються з різних доменів:

* Один фільм завантажує інший фільм за допомогою функцій `loadMovie*` (або інших хаків) і має доступ до тієї самої пісочниці або її частини.
+ Сторінка HTML використовує JavaScript для керування фільмом Adobe Flash, наприклад, викликом:
  * `GetVariable` для доступу до загальнодоступних і статичних об’єктів Flash із JavaScript у вигляді рядка.
  * `SetVariable` для встановлення статичного або загальнодоступного Flash-об’єкта на нове рядкове значення за допомогою JavaScript.
* Неочікуваний зв’язок між браузером і програмою SWF, що може призвести до викрадення даних із програми SWF.

XSF можна виконати шляхом примусового завантаження пошкодженого SWF-файлу зовнішнього поганого Flash-файлу. Ця атака може призвести до XSS або модифікації графічного інтерфейсу, щоб обдурити користувача, щоб він вставив облікові дані у підроблену форму Flash. XSF можна використовувати за наявності Flash HTML Injection або зовнішніх файлів SWF, коли використовуються методи `loadMovie*`.

## Відкрийте перенаправлячі

SWF-файли мають можливість навігації в браузері. Якщо SWF приймає місце призначення як FlashVar, тоді SWF можна використовувати як відкритий переспрямовувач. Відкритий перенаправляч — це будь-яка функція веб-сайту на надійному веб-сайті, яку зловмисник може використати для перенаправлення кінцевого користувача на шкідливий веб-сайт. Вони часто використовуються під час фішингових атак. Подібно до міжсайтового сценарію, атака передбачає натискання користувачем шкідливого посилання.

У випадку Flash шкідлива URL-адреса може виглядати так:

> `http://trusted.example.org/trusted.swf?getURLValue=http://www.evil-spoofing-website.org/phishEndUsers.html`

У наведеному вище прикладі кінцевий користувач може побачити, що URL-адреса починається з його улюбленого надійного веб-сайту, і натиснути його. Посилання завантажить надійний SWF, який приймає `getURLValue` і надає його виклику навігації браузера ActionScript:

> getURL(_root.getURLValue,"_self");

Це призведе до переходу браузера на шкідливу URL-адресу, надану зловмисником. На даний момент фішер успішно використав довіру користувача до trusted.example.org, щоб обманом змусити користувача відвідати їхній шкідливий веб-сайт. Звідти вони могли запустити нульовий день, здійснити підробку оригінального веб-сайту або будь-який інший тип атаки. SWF-файли можуть ненавмисно діяти як відкритий переспрямовувач на веб-сайті.

Розробникам слід уникати використання повних URL-адрес як FlashVars. Якщо вони планують здійснювати навігацію лише на власному веб-сайті, їм слід використовувати відносні URL-адреси або переконатися, що URL-адреса починається з довіреного домену та протоколу.

## Атаки та версія Flash Player

З травня 2007 року компанія Adobe випустила три нові версії Flash Player. Кожна нова версія обмежує деякі атаки, описані раніше.

| Версія плеєра | як функція | Зовнішній інтерфейс | GetURL | HTML Ін'єкція |
|:---:|:---:|:---:|:---:|
| v9.0 r47/48 | Так | Так | Так | Так |
| v9.0 r115 | Ні | Так | Так | Так |
| v9.0 r124 | Ні | Так | Так | Частково |

## Цілі тесту

* Декомпілювати та аналізувати код програми.
* Оцініть вхідні дані та використання небезпечних методів.

## Як тестувати
Після першої публікації [Тестування Flash-додатків](http://www.wisec.it/en/Docs/flash_App_testing_Owasp07.pdf) було випущено нові версії Flash Player, щоб пом’якшити деякі атаки, які будуть описані. Тим не менш, деякі проблеми все ще можуть бути використані, оскільки вони є результатом небезпечних методів програмування.

## Декомпіляція
Оскільки SWF-файли інтерпретуються віртуальною машиною, вбудованою в сам плеєр, їх можна потенційно декомпілювати та аналізувати. Найвідомішим і безкоштовним декомпілятором ActionScript 2.0 є flare.

Щоб декомпілювати файл SWF за допомогою flare, просто введіть:

`$ flare hello.swf`

Це призводить до створення нового файлу під назвою hello.flr.

Декомпіляція допомагає тестувальникам, оскільки вона дозволяє тестувати програми Flash у білому ящику. Швидкий пошук в Інтернеті може привести вас до різноманітних дизассемблерів і інструментів захисту спалахів.

## Невизначені змінні FlashVars
FlashVars — це змінні, які розробник SWF планував отримати з веб-сторінки. FlashVars зазвичай передаються з тегу Object або Embed у HTML. наприклад:

> `<object width="550" height="400" classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"`
> 
> `codebase="http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,124,0">`
> 
> `    <param name="movie" value="somefilename.swf">`
> 
> `    <param name="FlashVars" value="var1=val1&var2=val2">`
> 
> `    <embed src="somefilename.swf" width="550" height="400" FlashVars="var1=val1&var2=val2">`
> 
> `</embed>`
> 
> `</object>`

FlashVars також можна ініціалізувати з URL:

> `http://www.example.org/somefilename.swf?var1=val1&var2=val2`

У ActionScript 3.0 розробник повинен явно призначити значення FlashVar локальним змінним. Як правило, це виглядає так:

> `var paramObj:Object = LoaderInfo(this.root.loaderInfo).parameters;`
> 
> `var var1:String = String(paramObj["var1"]);`
> 
> `var var2:String = String(paramObj["var2"]);`

У ActionScript 2.0 будь-яка неініціалізована глобальна змінна вважається FlashVar. Глобальні змінні – це ті змінні, перед якими додаються `_root`, `_global` або `_level0`. Це означає, що якщо такий атрибут, як `_root.varname`, не визначений у всьому потоці коду, він може бути перезаписаний параметрами URL:

> `http://victim/file.swf?varname=value`

Незалежно від того, чи ви використовуєте ActionScript 2.0 чи ActionScript 3.0, FlashVars може бути вектором атаки. Давайте розглянемо код ActionScript 2.0, який є вразливим:

Приклад:

> movieClip 328 __Packages.Locale {
> 
> #initclip
>     if (!_global.Locale) {'
>     var v1 = function (on_load) {
>         var v5 = new XML();
>         var v6 = this;
>         v5.onLoad = function (success) {
>         if (success) {
>             trace('Locale loaded xml');
>             var v3 = this.xliff.file.body.$trans_unit;
>             var v2 = 0;
>             while (v2 < v3.length) {
>             Locale.strings[v3[v2]._resname] = v3[v2].source.__text;
>             ++v2;
>             }
>             on_load();
>         } else {}
>         };
>         if (_root.language != undefined) {
>         Locale.DEFAULT_LANG = _root.language;
>         }
>         v5.load(Locale.DEFAULT_LANG + '/player_' +
>                             Locale.DEFAULT_LANG + '.xml');
>     };

